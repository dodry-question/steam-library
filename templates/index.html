<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?v=7">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; padding: 40px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background-color: #171a21; padding: 15px 20px; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1 { color: #ffffff; text-shadow: 0 0 5px #66c0f4; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-profile { display: flex; align-items: center; justify-content: flex-end; }
        .user-info-col { display: flex; flex-direction: column; justify-content: center; line-height: 1.2; text-align: right; margin-right: 12px; }
        .user-name { font-weight: bold; color: #66c0f4; font-size: 14px; white-space: nowrap; }
        .btn-logout { color: #8f98a0; text-decoration: none; font-size: 11px; text-transform: uppercase; }
        .btn-logout:hover { color: #ffffff; text-decoration: underline; }
        
        .btn-steam { background-color: #2f363d; color: #e5e5e5; text-decoration: none; padding: 8px 16px; font-weight: bold; display: inline-flex; align-items: center; gap: 10px; border-radius: 2px; border: 1px solid #3e464e; transition: 0.2s; font-size: 14px; }
        .btn-steam:hover { background-color: #434953; color: white; border-color: #66c0f4; }
        .steam-icon { width: 18px; height: 18px; background: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Steam_icon_logo.svg') no-repeat center/contain; }

        .controls { background: #101216; padding: 15px; border-radius: 4px; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 20px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.8); border: 1px solid #3e464e; }
        .controls-right { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        button { padding: 8px 16px; border-radius: 2px; border: none; font-weight: normal; cursor: pointer; transition: 0.2s; color: white; font-size: 13px; font-family: 'Segoe UI', sans-serif; }
        .btn-load { background: linear-gradient( to bottom, #a4d007 5%, #536904 95%); color: #fff; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); font-weight: bold; }
        .btn-load:hover { background: linear-gradient( to bottom, #b6e608 5%, #536904 95%); }
        .btn-clear { background-color: #2a2d33; color: #aaa; }
        .btn-sort { background-color: #2a3f5a; color: #66c0f4; }
        .btn-ai { background: linear-gradient(45deg, #6b2cf5, #b829e3); font-weight: bold; }

        .input-friend { padding: 8px; border-radius: 2px 0 0 2px; border: 1px solid #3e464e; background: #222b35; color: white; width: 180px; }
        .btn-friend { border-radius: 0 2px 2px 0; background-color: #67c1f5; color: #1b2838; font-weight: bold; }

        .gallery { display: flex; flex-wrap: wrap; gap: 16px; }
        
        /* –ö–ê–†–¢–û–ß–ö–ê –ò–ì–†–´ (–ï–î–ò–ù–ê–Ø –î–õ–Ø –í–°–ï–•) */
        .card { 
            background-color: #16202d; width: 280px; position: relative; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.2); 
            animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column; 
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.5); border-color: #66c0f4; z-index: 10; }
        
        img { width: 100%; min-height: 130px; object-fit: cover; background: #0c0f12; }
        .info { padding: 10px; flex-grow: 1; }
        h2 { font-size: 15px; margin: 0 0 5px 0; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .genres { font-size: 11px; color: #5c7e10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playtime { font-size: 11px; color: #697885; margin-top: 2px; }
        
        .price-block { display: flex; justify-content: space-between; align-items: center; background-color: #00000033; padding: 6px 10px; margin-top: auto; }
        .price { font-size: 13px; color: #acb2b8; }
        .discount-badge { background-color: #4c6b22; color: #beee11; padding: 1px 4px; border-radius: 1px; font-size: 13px; font-weight: bold; }

        #ai-block { display: none; background: #121418; border: 1px solid #6b2cf5; padding: 20px; margin-bottom: 30px; }
        #status-bar { margin-bottom: 20px; color: #66c0f4; font-size: 14px; font-weight: bold; min-height: 20px; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #66c0f4; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite; margin-right: 8px; vertical-align: text-bottom; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div class="header">
        <h1>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
        {% if user_id %}
            <div class="user-profile">
                <div class="user-info-col">
                    <span class="user-name">{{ user_name }}</span>
                    <a href="/logout" class="btn-logout">–í—ã–π—Ç–∏</a>
                </div>
                <div style="width: 40px; height: 40px; min-width: 40px; min-height: 40px; flex-shrink: 0; border: 1px solid #66c0f4; border-radius: 3px; overflow: hidden;">
                    <img src="{{ user_avatar }}" style="width: 100%; height: 100%; object-fit: cover; min-height: 0;" onerror="this.style.display='none'">
                </div>
            </div>
        {% else %}
            <a href="/login" class="btn-steam"><div class="steam-icon"></div>Sign in through Steam</a>
        {% endif %}
    </div>

    <div class="controls">
        {% if user_id %}
            <button onclick="loadLibrary()" class="btn-load" id="btn-main">–ú–æ–∏ –∏–≥—Ä—ã</button>
        {% endif %}
        <button onclick="clearList()" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <span style="color: #454d58;">|</span>
        <button onclick="sortGames('playtime')" class="btn-sort">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</button>
        <button onclick="sortGames('price')" class="btn-sort">–ü–æ —Ü–µ–Ω–µ</button>

        <div class="controls-right">
            <button onclick="getAI()" class="btn-ai">‚ú® AI –°–æ–≤–µ—Ç</button>
            <div style="display: flex;">
                <input type="text" id="friend-id" class="input-friend" placeholder="ID –¥—Ä—É–≥–∞ / –°—Å—ã–ª–∫–∞">
                <button onclick="loadLibrary(true)" class="btn-friend">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="ai-block"></div>
    <div id="status-bar"></div>
    <div class="gallery" id="container"></div>

    <script>
        let loadedGames = [];
        let isProcessing = false;

        function clearList() {
            if(isProcessing) return;
            document.getElementById('container').innerHTML = '';
            loadedGames = [];
            document.getElementById('status-bar').innerText = '';
            document.getElementById('ai-block').style.display = 'none';
        }

        async function loadLibrary(isFriend = false) {
            if (isProcessing) return;
            isProcessing = true;
            
            if (!isFriend && "{{ user_id }}" === "None") {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Steam!");
                isProcessing = false;
                return;
            }

            const btn = document.getElementById('btn-main');
            if (btn) btn.disabled = true;
            clearList();

            const statusBar = document.getElementById('status-bar');
            
            try {
                let url = '/api/get-games-list';
                if (isFriend) {
                    const inp = document.getElementById('friend-id').value;
                    if(inp) url += `?user_id=${encodeURIComponent(inp)}`;
                }

                statusBar.innerHTML = '<span class="spinner"></span>–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä...';
                
                const listResp = await fetch(url);
                if (!listResp.ok) throw new Error(`HTTP ${listResp.status}`);
                const listData = await listResp.json();

                if (listData.error) {
                    statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞: ${listData.error}</span>`;
                    isProcessing = false;
                    if(btn) btn.disabled = false;
                    return;
                }

                const gamesList = listData.games;
                if (!gamesList || gamesList.length === 0) {
                    statusBar.innerText = "–ò–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
                    isProcessing = false;
                    if(btn) btn.disabled = false;
                    return;
                }

                statusBar.innerText = `–ù–∞–π–¥–µ–Ω–æ ${gamesList.length} –∏–≥—Ä. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏...`;

                const steamIds = gamesList.map(g => g.appid);
                const playtimes = {};
                const gameNames = {};
                gamesList.forEach(g => {
                    playtimes[g.appid] = g.playtime;
                    gameNames[g.appid] = g.name; 
                });

                const batchResp = await fetch('/api/games-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        steam_ids: steamIds, 
                        playtimes: playtimes,
                        game_names: gameNames 
                    })
                });

                const reader = batchResp.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";
                let count = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split("\n");
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const game = JSON.parse(line);
                                loadedGames.push(game);
                                addCard(game);
                                count++;
                                statusBar.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${count} –∏–∑ ${gamesList.length}`;
                            } catch (e) { console.error(e); }
                        }
                    }
                }
                statusBar.innerHTML = `‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (${count} —à—Ç)`;

            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞: " + e.message);
                statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>`;
            } finally {
                isProcessing = false;
                if(btn) btn.disabled = false;
            }
        }

        function addCard(game) {
            const div = document.createElement('div');
            div.className = 'card';
            
            let hours = Math.round(game.playtime_forever / 60);
            let timeStr = hours > 0 ? `${hours} —á. –≤ –∏–≥—Ä–µ` : "–ù–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å";
            let discountHtml = game.discount_percent > 0 ? `<div class="discount-badge">-${game.discount_percent}%</div>` : '<div></div>';
            
            div.innerHTML = `
                <a href="https://store.steampowered.com/app/${game.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                    <img src="${game.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/280x130?text=No+Image'">
                    <div class="info">
                        <h2>${game.name}</h2>
                        <div class="genres">${game.genres || ""}</div>
                        <div class="playtime">${timeStr}</div>
                    </div>
                </a>
                <div class="price-block">
                    ${discountHtml}
                    <div class="price">${game.price_str || ""}</div>
                </div>
            `;
            document.getElementById('container').appendChild(div);
        }

        function sortGames(type) {
            const container = document.getElementById('container');
            if (loadedGames.length === 0) return;
            container.innerHTML = '';
            loadedGames.sort((a, b) => {
                if (type === 'playtime') return b.playtime_forever - a.playtime_forever;
                if (type === 'price') {
                    const getP = (s) => {
                        if (!s || s === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") return 0;
                        if (s.includes("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ") || s.includes("–ù–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è")) return -1;
                        return parseFloat(s.replace(/[^0-9,.]/g, '').replace(',', '.'));
                    };
                    return getP(b.price_str) - getP(a.price_str);
                }
            });
            loadedGames.forEach(addCard);
        }

        async function getAI() {
            if (loadedGames.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–≥—Ä—ã!"); return; }
            const block = document.getElementById('ai-block');
            block.style.display = 'block';
            block.innerHTML = '<span class="spinner"></span> –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...';
            
            try {
                const resp = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ games: loadedGames })
                });
                const data = await resp.json();
                const recs = data.content.recommendations;
                
                if(recs && recs.length > 0) {
                    let html = '<h3 style="color:#fff; margin-top:0;">ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3><div class="gallery" style="margin-top:10px;">';
                    
                    recs.forEach(r => {
                        html += `
                        <div class="card" style="animation:none;">
                             <a href="https://store.steampowered.com/app/${r.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                                <img src="${r.image_url}" loading="lazy">
                                <div class="info">
                                    <h2>${r.name}</h2>
                                    <div class="playtime" style="color: #beee11; margin-top:5px; line-height:1.2;">${r.ai_reason}</div>
                                </div>
                            </a>
                            <div class="price-block">
                                <div></div>
                                <div class="price">–û—Ç–∫—Ä—ã—Ç—å –≤ Steam</div>
                            </div>
                        </div>`;
                    });
                    
                    html += '</div>';
                    block.innerHTML = html;
                } else {
                    block.innerHTML = '–ò–ò –Ω–µ –¥–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.';
                }
            } catch(e) {
                block.innerHTML = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI.';
            }
        }
    </script>
</body>
</html>