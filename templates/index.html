<!DOCTYPE html>
<html>
<head>
    <title>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Steam</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?v=4">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; padding: 40px; margin: 0; }
        
        /* --- –®–ê–ü–ö–ê --- */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 25px; background-color: #171a21; padding: 15px 20px;
            border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        h1 { color: #ffffff; text-shadow: 0 0 5px #66c0f4; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-profile { display: flex; align-items: center; gap: 12px; height: 40px; }
        .user-avatar { width: 38px; height: 38px; min-width: 38px; min-height: 38px; border-radius: 3px; border: 1px solid #66c0f4; object-fit: cover; display: block; }
        .user-info-col { display: flex; flex-direction: column; justify-content: center; line-height: 1.2; }
        .user-name { font-weight: bold; color: #66c0f4; font-size: 14px; }
        .btn-logout { color: #8f98a0; text-decoration: none; font-size: 11px; text-transform: uppercase; transition: 0.2s; }
        .btn-logout:hover { color: #ffffff; text-decoration: underline; }
        .btn-steam { background-color: #2f363d; color: #e5e5e5; text-decoration: none; padding: 8px 16px; font-weight: bold; display: inline-flex; align-items: center; gap: 10px; border-radius: 2px; border: 1px solid #3e464e; transition: 0.2s; font-size: 14px; }
        .btn-steam:hover { background-color: #434953; color: white; border-color: #66c0f4; }
        .steam-icon { width: 18px; height: 18px; background: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Steam_icon_logo.svg') no-repeat center/contain; }

       /* --- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø (–õ–ò–ü–ö–ê–Ø) --- */
        .controls { 
            background: #101216; 
            padding: 15px; 
            border-radius: 4px; 
            margin-bottom: 30px; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            align-items: center;
            
            position: sticky;
            top: 20px; 
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            border: 1px solid #3e464e;
        }
        .btn-control { padding: 8px 16px; border-radius: 2px; border: none; font-weight: normal; cursor: pointer; transition: 0.2s; color: white; font-size: 13px; font-family: 'Segoe UI', sans-serif; }
        .btn-load { background: linear-gradient( to bottom, #a4d007 5%, #536904 95%); color: #fff; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); font-weight: bold; }
        .btn-load:hover { background: linear-gradient( to bottom, #b6e608 5%, #536904 95%); }
        .btn-clear { background-color: #2a2d33; color: #aaa; }
        .btn-clear:hover { background-color: #3d4149; color: white; }
        .btn-sort { background-color: #2a3f5a; color: #66c0f4; }
        .btn-sort:hover { background-color: #43628a; color: white; }
        
        /* –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ */
        .search-form { display: flex; gap: 10px; margin-left: auto; align-items: center; }
        .input-group { display: flex; }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥—Ä—É–≥–∞ */
        .input-friend { padding: 8px; border-radius: 2px 0 0 2px; border: 1px solid #3e464e; background: #222b35; color: white; outline: none; width: 180px; border-right: none; }
        .btn-friend { padding: 8px 12px; border-radius: 0 2px 2px 0; border: none; background-color: #67c1f5; color: #1b2838; cursor: pointer; font-weight: bold; }
        .btn-friend:hover { background-color: #419dc9; }

        /* –ü–æ–ª–µ ID (—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ) */
        .input-manual { padding: 8px; border-radius: 2px 0 0 2px; border: 1px solid #000; background: #181d23; color: white; outline: none; width: 100px; border-right: none; }
        .btn-find { padding: 8px 12px; border-radius: 0 2px 2px 0; border: none; background-color: #2f363d; color: white; cursor: pointer; font-weight: 600; border: 1px solid #3e464e; }
        .btn-find:hover { background-color: #434953; border-color: #66c0f4; }

        #status-bar { margin-bottom: 20px; color: #66c0f4; font-size: 14px; height: 20px; font-weight: bold; padding-left: 5px; display: flex; align-items: center; }

        /* --- UI –î–õ–Ø –ü–û–î–°–ö–ê–ó–ö–ò (–ó–ù–ê–ö –í–û–ü–†–û–°–ê) --- */
        .help-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 20px; height: 20px;
            background-color: #3d4450; color: #c7d5e0;
            border-radius: 50%; font-size: 12px; font-weight: bold;
            cursor: help; margin-left: 10px; position: relative;
            border: 1px solid #565e69;
        }
        .help-icon:hover { background-color: #66c0f4; color: #171a21; border-color: #66c0f4; }
        .help-icon .tooltip-text {
            visibility: hidden; width: 220px;
            background-color: #16202d; color: #fff;
            text-align: center; border-radius: 4px;
            padding: 8px; position: absolute; z-index: 2000;
            top: 140%; left: 50%; margin-left: -110px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid #66c0f4; opacity: 0; transition: opacity 0.3s;
            font-size: 12px; font-weight: normal; line-height: 1.4; pointer-events: none;
        }
        .help-icon .tooltip-text::after {
            content: ""; position: absolute; top: -10px; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; 
            border-color: transparent transparent #66c0f4 transparent;
        }
        .help-icon:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* --- –ì–ê–õ–ï–†–ï–Ø --- */
        .gallery { display: flex; flex-wrap: wrap; gap: 16px; }
        .card { 
            background-color: #16202d; width: 280px; position: relative; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.5); border-color: #66c0f4; z-index: 10; transition: transform 0.2s; }
        .card-link { display: block; text-decoration: none; color: inherit; flex-grow: 1; }
        img { width: 100%; display: block; min-height: 130px; background: #0c0f12; object-fit: cover; }
        .info { padding: 10px; }
        h2 { font-size: 15px; margin: 0 0 5px 0; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .genres { font-size: 11px; color: #5c7e10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playtime { font-size: 11px; color: #697885; margin-top: 2px; }
        .price-block { display: flex; justify-content: space-between; align-items: center; background-color: #00000033; padding: 6px 10px; margin-top: auto; }
        .price { font-size: 13px; color: #acb2b8; }
        .discount-badge { background-color: #4c6b22; color: #beee11; padding: 1px 4px; border-radius: 1px; font-size: 13px; font-weight: bold; }
        
        /* --- –°–ü–ò–ù–ù–ï–† --- */
        .spinner {
            display: inline-block; width: 18px; height: 18px;
            border: 3px solid rgba(102, 192, 244, 0.3); border-radius: 50%;
            border-top-color: #66c0f4; animation: spin 1s ease-in-out infinite;
            margin-right: 10px; vertical-align: sub;
        }
        .btn-friend .spinner { border-color: rgba(27, 40, 56, 0.2); border-top-color: #1b2838; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø AI –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô (–ù–û–í–û–ï) --- */
        #ai-section {
            display: none;
            background: #121418;
            border: 1px solid #6b2cf5;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(107, 44, 245, 0.15);
            animation: fadeIn 0.5s ease-out;
        }

        .ai-header {
            color: #fff; font-size: 18px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }

        .ai-cards-row {
            display: flex; gap: 20px; justify-content: flex-start;
            flex-wrap: wrap; margin-bottom: 15px;
        }

        .ai-card {
            background-color: #1b2838; width: 280px; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid #3e464e;
            transition: transform 0.2s; display: flex; flex-direction: column;
        }
        .ai-card:hover { transform: translateY(-5px); border-color: #a4d007; }

        .ai-reasons-block {
            margin-top: 15px; display: flex; flex-direction: column; gap: 10px;
        }

        .ai-reason-item {
            background: #222b35; padding: 10px 15px;
            border-left: 3px solid #a4d007; color: #c7d5e0;
            font-size: 14px; line-height: 1.4;
        }
        .ai-reason-title {
            font-weight: bold; color: #fff; margin-bottom: 3px; display: block;
        }
    </style>
</head>
<body>
    
    <div class="header">
        <h1>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
        {% if user_id %}
            <div class="user-profile">
                <img src="{{ user_avatar }}" class="user-avatar">
                <div class="user-info-col">
                    <span class="user-name">{{ user_name }}</span>
                    <a href="/logout" class="btn-logout">–í—ã–π—Ç–∏</a>
                </div>
            </div>
        {% else %}
            <a href="/login" class="btn-steam"><div class="steam-icon"></div>Sign in through Steam</a>
        {% endif %}
    </div>

    <div class="controls">
        {% if user_id %}
            <button onclick="loadLibrary(null)" class="btn-control btn-load">–ú–æ–∏ –∏–≥—Ä—ã</button>
        {% endif %}
        <button onclick="clearList()" class="btn-control btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <span style="color: #454d58; margin: 0 10px;">|</span>
        <button onclick="sortGames('playtime')" class="btn-control btn-sort">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</button>
        <button onclick="sortGames('price_desc')" class="btn-control btn-sort">–î–æ—Ä–æ–≥–∏–µ</button>
        <button onclick="sortGames('price_asc')" class="btn-control btn-sort">–î–µ—à–µ–≤—ã–µ</button>
        <button onclick="askAI()" class="btn-control" style="background: linear-gradient(45deg, #6b2cf5, #b829e3); border: none; font-weight: bold;">‚ú® AI –°–æ–≤–µ—Ç</button>

        <div class="search-form">
            <form onsubmit="loadFriendLibrary(event)" class="input-group">
                <input type="text" id="friend-input" class="input-friend" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å..." required>
                <button type="submit" class="btn-friend">–ù–∞–π—Ç–∏</button>
            </form>
            <form onsubmit="findGameManual(event)" class="input-group">
                <input type="number" id="manual-steam-id" class="input-manual" placeholder="AppID" required>
                <button type="submit" class="btn-find">+</button>
            </form>
        </div>
    </div>

    <!-- –ë–õ–û–ö –î–õ–Ø –í–´–í–û–î–ê –û–¢–í–ï–¢–ê –ò–ò -->
    <div id="ai-section">
        <div class="ai-header">
            <span>ü§ñ</span>
            <span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –≤–∫—É—Å–æ–≤</span>
        </div>
        <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        <div class="ai-cards-row" id="ai-cards-container"></div>
        <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç -->
        <div class="ai-reasons-block" id="ai-reasons-container"></div>
    </div>

    <div id="status-bar"></div>
    <div class="gallery" id="games-container"></div>

    <script>
        const userId = "{{ user_id }}";
        const container = document.getElementById('games-container');
        const statusBar = document.getElementById('status-bar');
        
        let loadedGames = [];
        let userPlaytimeMap = {}; 
        let isLoading = false;

        // --- –û–ß–ò–°–¢–ö–ê ---
        function clearList() {
            if (isLoading) return;
            container.innerHTML = '';
            loadedGames = []; 
            statusBar.innerText = "";
            document.getElementById('ai-section').style.display = 'none';
        }

        // --- –†–£–ß–ù–û–ô –ü–û–ò–°–ö –ò–ì–†–´ ---
        async function findGameManual(event) {
            event.preventDefault(); 
            const input = document.getElementById('manual-steam-id');
            const steamId = input.value;
            if (!steamId) return;

            const btn = document.querySelector('.btn-find');
            const originalText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('steam_id', steamId);

                const response = await fetch('/api/add-game', {
                    method: 'POST',
                    body: formData
                });
                const gameData = await response.json();

                if (gameData.error) {
                    alert("–ò–≥—Ä–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Steam –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.");
                } else {
                    const existingIndex = loadedGames.findIndex(g => g.steam_id == gameData.steam_id);
                    if (existingIndex > -1) loadedGames.splice(existingIndex, 1);
                    
                    const existingCard = document.querySelector(`.card[data-steam-id="${gameData.steam_id}"]`);
                    if (existingCard) existingCard.remove();

                    if (userPlaytimeMap[gameData.steam_id]) {
                        gameData.playtime_forever = userPlaytimeMap[gameData.steam_id];
                    }

                    loadedGames.push(gameData);
                    const card = createCardElement(gameData);
                    
                    if (container.firstChild) container.insertBefore(card, container.firstChild);
                    else container.appendChild(card);
                    
                    card.style.animation = "none"; 
                    setTimeout(() => { card.style.animation = "fadeIn 0.5s ease-out"; }, 10);
                }
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                input.value = ''; 
            }
        }

       // --- –ó–ê–ì–†–£–ó–ö–ê –î–†–£–ì–ê ---
        async function loadFriendLibrary(event) {
            event.preventDefault();
            const input = document.getElementById('friend-input');
            const val = input.value.trim();
            if(!val) return;
            await loadLibrary(val);
        }

        // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ---
        async function loadLibrary(targetInput = null) {
            if (isLoading) return;
            
            if (!targetInput && (!userId || userId === "None")) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Steam, —á—Ç–æ–±—ã –≥—Ä—É–∑–∏—Ç—å '—Å–≤–æ–∏' –∏–≥—Ä—ã.");
                return;
            }

            isLoading = true;
            let activeBtn = targetInput ? document.querySelector('.btn-friend') : document.querySelector('.btn-load');
            const originalText = activeBtn ? activeBtn.innerText : "";
            if (activeBtn) {
                activeBtn.disabled = true;
                activeBtn.innerHTML = '<div class="spinner"></div>';
            }

            try {
                container.innerHTML = '';
                loadedGames = []; 
                userPlaytimeMap = {};
                statusBar.innerText = targetInput ? '–†–∞–∑—Ä–µ—à–∞–µ–º ID –ø—Ä–æ—Ñ–∏–ª—è...' : '–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∏–≥—Ä...';
                document.getElementById('ai-section').style.display = 'none';
                
                let url = '/api/get-games-list';
                if (targetInput) url += `?user_id=${encodeURIComponent(targetInput)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞: ${data.error}. –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç.</span>`;
                    isLoading = false;
                    if(activeBtn) { activeBtn.disabled = false; activeBtn.innerText = originalText; }
                    return;
                }

                if (!data.games || data.games.length === 0) {
                    statusBar.innerText = "–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (0 –∏–≥—Ä –∏–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å).";
                    isLoading = false;
                    if(activeBtn) { activeBtn.disabled = false; activeBtn.innerText = originalText; }
                    return;
                }

                data.games.forEach(g => { userPlaytimeMap[g.appid] = g.playtime; });

                const totalFound = data.games.length;
                statusBar.innerText = `–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${totalFound}. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...`;

                const chunks = chunkArray(data.games, 10); 

                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    const payload = {
                        steam_ids: chunk.map(g => g.appid),
                        playtimes: {}
                    };
                    chunk.forEach(g => payload.playtimes[g.appid] = g.playtime);

                    try {
                        const batchResp = await fetch('/api/games-batch', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });

                        const reader = batchResp.body.getReader();
                        const decoder = new TextDecoder("utf-8");
                        let buffer = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split("\n");
                            buffer = lines.pop(); 

                            for (const line of lines) {
                                if (line.trim()) {
                                    try {
                                        const game = JSON.parse(line);
                                        loadedGames.push(game);
                                        const card = createCardElement(game);
                                        container.appendChild(card);
                                        statusBar.innerHTML = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: <span style="color: white; margin: 0 5px;">${loadedGames.length}</span> –∏–∑ <span style="margin-left: 5px;">${totalFound}</span>`;
                                    } catch (e) { console.error(e); }
                                }
                            }
                        }
                    } catch (e) { console.error(e); }
                }
                
                const hiddenCount = totalFound - loadedGames.length;
                let nameToShow = data.target_name || data.target_id;
                const safeName = nameToShow.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                let ownerText = targetInput ? ` –¥–ª—è –¥—Ä—É–≥–∞ (<strong style="color: #66c0f4;">${safeName}</strong>)` : "";
                
                let statusHtml = `‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞${ownerText} –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ü–æ–∫–∞–∑–∞–Ω–æ: <span style="color: #fff;">${loadedGames.length}</span>`;
                if (hiddenCount > 0) {
                    statusHtml += ` <div class="help-icon">?<span class="tooltip-text">–°–∫—Ä—ã—Ç–æ ${hiddenCount} (–º—É—Å–æ—Ä/–±–µ–∑ —Ü–µ–Ω—ã).</span></div>`;
                }
                statusBar.innerHTML = statusHtml;

            } catch (e) {
                console.error(e);
                statusBar.innerText = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ JS.";
            } finally {
                isLoading = false;
                if (activeBtn) {
                    activeBtn.disabled = false;
                    activeBtn.innerText = originalText;
                }
            }
        }

        // --- –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø AI –°–û–í–ï–¢–û–í (–ö–ê–†–¢–û–ß–ö–ò) ---
        async function askAI() {
            if (loadedGames.length === 0) {
                alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É!");
                return;
            }

            const aiSection = document.getElementById('ai-section');
            const cardsContainer = document.getElementById('ai-cards-container');
            const reasonsContainer = document.getElementById('ai-reasons-container');
            const btn = document.querySelector('.btn-control[onclick="askAI()"]');
            
            // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            aiSection.style.display = 'block';
            cardsContainer.innerHTML = '';
            reasonsContainer.innerHTML = '<div style="color:#aaa; padding:10px;">ü§ñ –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ —Ç–æ–ø –∏–≥—Ä—ã –∏ –∏—â–µ—Ç –ø–æ—Ö–æ–∂–∏–µ... (–ñ–¥–µ–º ~10 —Å–µ–∫)</div>';
            
            btn.disabled = true;

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        games: loadedGames.map(g => ({
                            name: g.name,
                            playtime: g.playtime_forever
                        })) 
                    })
                });
                
                const data = await response.json();
                
                reasonsContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏

                if (data.content && data.content.error) {
                    reasonsContainer.innerHTML = `<div style="color:red">${data.content.error}</div>`;
                    return;
                }

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ JSON)
                if (typeof data.content === 'string') {
                     reasonsContainer.innerHTML = `<div style="padding:10px;">${data.content}</div>`;
                     return;
                }

                const recommendations = data.content.recommendations;
                
                if (!recommendations || recommendations.length === 0) {
                    reasonsContainer.innerHTML = "<div style='padding:10px;'>–ò–ò –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –∏–≥—Ä—ã –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞.</div>";
                    return;
                }

                recommendations.forEach(game => {
                    // 1. –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                    const card = document.createElement('div');
                    card.className = 'ai-card';
                    
                    let discountHtml = game.discount_percent > 0 ? `<div class="discount-badge">-${game.discount_percent}%</div>` : '<div></div>';
                    const imgUrl = game.image_url ? game.image_url : 'https://via.placeholder.com/280x130?text=No+Image';

                    card.innerHTML = `
                        <a href="https://store.steampowered.com/app/${game.steam_id}" target="_blank" class="card-link">
                            <img src="${imgUrl}" alt="${game.name}">
                            <div class="info">
                                <h2>${game.name}</h2>
                                <div class="genres">${game.genres || '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è'}</div>
                            </div>
                        </a>
                        <div class="price-block">
                            ${discountHtml}
                            <div class="price">${game.price_str || ''}</div>
                        </div>
                    `;
                    cardsContainer.appendChild(card);

                    // 2. –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏—á–∏–Ω—ã
                    const reasonItem = document.createElement('div');
                    reasonItem.className = 'ai-reason-item';
                    reasonItem.innerHTML = `
                        <span class="ai-reason-title">–ü–æ—á–µ–º—É ${game.name}?</span>
                        ${game.ai_reason}
                    `;
                    reasonsContainer.appendChild(reasonItem);
                });
                
            } catch (e) {
                console.error(e);
                reasonsContainer.innerHTML = '<div style="color:red; padding:10px;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.</div>';
            } finally {
                btn.disabled = false;
            }
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function chunkArray(array, size) {
            const result = [];
            for (let i = 0; i < array.length; i += size) {
                result.push(array.slice(i, i + size));
            }
            return result;
        }

        function createCardElement(info) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.steamId = info.steam_id;
            
            let hours = Math.round(info.playtime_forever / 60);
            let timeText = hours > 0 ? `${hours} —á. –≤ –∏–≥—Ä–µ` : "–ù–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å";
            let discountHtml = info.discount_percent > 0 ? `<div class="discount-badge">-${info.discount_percent}%</div>` : '<div></div>';
            const imgUrl = info.image_url ? info.image_url : 'https://via.placeholder.com/280x130?text=No+Image';

            card.innerHTML = `
                <a href="https://store.steampowered.com/app/${info.steam_id}" target="_blank" class="card-link">
                    <img src="${imgUrl}" alt="${info.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/280x130?text=Error';">
                    <div class="info">
                        <h2>${info.name}</h2>
                        <div class="genres">${info.genres || ''}</div>
                        <div class="playtime">${timeText}</div>
                    </div>
                </a>
                <div class="price-block">
                    ${discountHtml}
                    <div class="price">${info.price_str || ''}</div>
                </div>
            `;
            return card;
        }

        function renderOneCard(info) {
            const card = createCardElement(info);
            container.appendChild(card);
        }

        function sortGames(type) {
            if (isLoading) return; 
            if (loadedGames.length === 0) return;
            
            loadedGames.sort((a, b) => {
                const badStatus = "–ù–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è";
                const isBadA = a.price_str === badStatus;
                const isBadB = b.price_str === badStatus;

                if (isBadA && !isBadB) return 1;
                if (!isBadA && isBadB) return -1;

                if (type === 'playtime') return b.playtime_forever - a.playtime_forever;
                if (type === 'price_desc' || type === 'price_asc') {
                    const pA = parsePrice(a.price_str);
                    const pB = parsePrice(b.price_str);
                    return type === 'price_desc' ? pB - pA : pA - pB;
                }
                return 0;
            });
            
            container.innerHTML = '';
            loadedGames.forEach(renderOneCard);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function parsePrice(priceStr) {
            if (!priceStr || priceStr === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") return 0;
            if (priceStr === "–ù–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è" || priceStr === "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –†–§") return -1;
            
            if (priceStr.includes("$")) {
                let val = parseFloat(priceStr.replace(/[^0-9,.]/g, '').replace(',', '.'));
                return val * 95; 
            }
            return parseFloat(priceStr.replace(/[^0-9,.]/g, '').replace(',', '.'));
        }
    </script>
</body>
</html>