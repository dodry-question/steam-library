<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?v=7">
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; padding: 40px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background-color: #171a21; padding: 15px 20px; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1 { color: #ffffff; text-shadow: 0 0 5px #66c0f4; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-profile { display: flex; align-items: center; justify-content: flex-end; }
        .user-info-col { display: flex; flex-direction: column; justify-content: center; line-height: 1.2; text-align: right; margin-right: 12px; }
        .user-name { font-weight: bold; color: #66c0f4; font-size: 14px; white-space: nowrap; }
        .btn-logout { color: #8f98a0; text-decoration: none; font-size: 11px; text-transform: uppercase; }
        .btn-logout:hover { color: #ffffff; text-decoration: underline; }
        
        .btn-steam { background-color: #2f363d; color: #e5e5e5; text-decoration: none; padding: 8px 16px; font-weight: bold; display: inline-flex; align-items: center; gap: 10px; border-radius: 2px; border: 1px solid #3e464e; transition: 0.2s; font-size: 14px; }
        .btn-steam:hover { background-color: #434953; color: white; border-color: #66c0f4; }
        .steam-icon { width: 18px; height: 18px; background: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Steam_icon_logo.svg') no-repeat center/contain; }

        /* --- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        .controls { background: #101216; padding: 15px; border-radius: 4px; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 20px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.8); border: 1px solid #3e464e; }
        .controls-right { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        button { padding: 8px 16px; border-radius: 2px; border: none; font-weight: normal; cursor: pointer; transition: 0.2s; color: white; font-size: 13px; font-family: 'Segoe UI', sans-serif; }
        .btn-load { background: linear-gradient( to bottom, #a4d007 5%, #536904 95%); color: #fff; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); font-weight: bold; }
        .btn-load:hover { background: linear-gradient( to bottom, #b6e608 5%, #536904 95%); }
        .btn-clear { background-color: #2a2d33; color: #aaa; }
        .btn-sort { background-color: #2a3f5a; color: #66c0f4; }
        .btn-ai { background: linear-gradient(45deg, #6b2cf5, #b829e3); font-weight: bold; }

        .input-friend { padding: 8px; border-radius: 2px 0 0 2px; border: 1px solid #3e464e; background: #222b35; color: white; width: 180px; }
        .btn-friend { border-radius: 0 2px 2px 0; background-color: #67c1f5; color: #1b2838; font-weight: bold; }

        /* --- –ì–ê–õ–ï–†–ï–Ø –ò –ö–ê–†–¢–û–ß–ö–ò --- */
        .gallery { display: flex; flex-wrap: wrap; gap: 16px; }
        .card { 
            background-color: #16202d; width: 280px; position: relative; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.2); 
            animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column; 
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.5); border-color: #66c0f4; z-index: 10; }
        
        img { width: 100%; min-height: 130px; object-fit: cover; background: #0c0f12; }
        .info { padding: 10px; flex-grow: 1; }
        h2 { font-size: 15px; margin: 0 0 5px 0; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .genres { font-size: 11px; color: #5c7e10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playtime { font-size: 11px; color: #697885; margin-top: 2px; }
        
        .price-block { display: flex; justify-content: space-between; align-items: center; background-color: #00000033; padding: 6px 10px; margin-top: auto; }
        .price { font-size: 13px; color: #acb2b8; }
        .price.free { color: #a4d007; font-weight: bold; } 
        .discount-badge { background-color: #4c6b22; color: #beee11; padding: 1px 4px; border-radius: 1px; font-size: 13px; font-weight: bold; }

        /* --- –†–ï–ì–ò–û–ù–ê–õ–¨–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø --- */
        .price.region-locked { color: #ff4444; cursor: default; text-decoration: none; position: relative; font-weight: bold; }
        .price.region-locked::after {
            content: attr(data-price); position: absolute; bottom: 125%; right: 0;
            background: #171a21; color: #fff; padding: 5px 10px; border-radius: 4px;
            border: 1px solid #ff4444; font-size: 12px; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: 0.2s; z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-weight: normal;
        }
        .price.region-locked:hover::after { opacity: 1; visibility: visible; }

        /* --- –ë–õ–û–ö –ò–ò –ò –ú–ï–ù–Æ –ù–ê–°–¢–†–û–ï–ù–ò–Ø --- */
        #ai-block { display: none; background: #121418; border: 1px solid #6b2cf5; padding: 20px; margin-bottom: 30px; border-radius: 4px; }
        #ai-block .ai-gallery { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; margin-top: 15px; }

        .mood-container { position: relative; display: inline-block; vertical-align: middle; }
        .mood-trigger { background: #2a2d33; border: 1px solid #3e464e; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 18px; }
        .mood-trigger:hover { border-color: #6b2cf5; background: #353941; }
        .mood-trigger .arrow { font-size: 10px; color: #697885; }
        
        .mood-menu { display: none; position: absolute; top: 110%; right: 0; background: #171a21; border: 1px solid #6b2cf5; border-radius: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.8); z-index: 2000; min-width: 220px; overflow: hidden; }
        .mood-item { padding: 10px 15px; color: #c7d5e0; cursor: pointer; font-size: 13px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .mood-item:hover { background: #6b2cf5; color: white; }
        .mood-item.active { background: #2a3f5a; color: #66c0f4; }

        #status-bar { margin-bottom: 20px; color: #66c0f4; font-size: 14px; font-weight: bold; min-height: 20px; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #66c0f4; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite; margin-right: 8px; vertical-align: text-bottom; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div class="header">
        <h1>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
        
        {% if user_id %}
            <div class="user-profile">
                <div class="user-info-col">
                    <span class="user-name">{{ user_name }}</span>
                    <a href="/logout" class="btn-logout">–í—ã–π—Ç–∏</a>
                </div>
                
                <!-- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∏ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞ -->
                <div style="width: 64px; height: 64px; position: relative; flex-shrink: 0; margin-left: 10px;">
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–∞–º–∫–æ–π –∏ —Ç–µ–Ω—å—é -->
                    <div style="width: 100%; height: 100%; border: 1px solid #3c3d3e; border-radius: 2px; overflow: hidden; box-shadow: 0 0 15px rgba(0,0,0,0.7);">
                        <img src="{{ user_avatar }}" 
                             style="width: 100%; height: 100%; object-fit: cover; display: block; image-rendering: -webkit-optimize-contrast;" 
                             onerror="this.src='https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg'">
                    </div>
                    <!-- –°–∏–Ω—è—è –ª–∏–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ "–í —Å–µ—Ç–∏" –∫–∞–∫ –≤ Steam -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #66c0f4; border-radius: 0 0 2px 2px; box-shadow: 0 -1px 5px rgba(102, 192, 244, 0.4);"></div>
                </div>
            </div>
        {% else %}
            <div style="margin-left: auto;">
                <a href="/login" class="btn-steam">
                    <div class="steam-icon"></div>
                    Sign in through Steam
                </a>
            </div>
        {% endif %}
    </div>

    <div class="controls">
        {% if user_id %}
            <button onclick="loadLibrary()" class="btn-load" id="btn-main">–ú–æ–∏ –∏–≥—Ä—ã</button>
        {% endif %}
        <button onclick="clearList()" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <span style="color: #454d58;">|</span>
        <button onclick="sortGames('playtime')" class="btn-sort">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</button>
        <button onclick="sortGames('price')" class="btn-sort">–ü–æ —Ü–µ–Ω–µ</button>

        <div class="controls-right">
            <div class="mood-container">
                <div class="mood-trigger" id="mood-trigger" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏">
                    <span id="current-mood-emoji">üíé</span>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="mood-menu" id="mood-menu">
                    <div class="mood-item active" data-value="hidden gems" data-emoji="üíé">üíé –°–∫—Ä—ã—Ç—ã–µ –∂–µ–º—á—É–∂–∏–Ω—ã</div>
                    <div class="mood-item" data-value="experimental indie" data-emoji="üß™">üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –∏–Ω–¥–∏</div>
                    <div class="mood-item" data-value="hardcore challenge" data-emoji="üíÄ">üíÄ –•–∞—Ä–¥–∫–æ—Ä –∏ –≤—ã–∑–æ–≤</div>
                    <div class="mood-item" data-value="relaxing atmosphere" data-emoji="‚òï">‚òï –ú–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–æ–µ / –û—Ç–¥—ã—Ö</div>
                    <div class="mood-item" data-value="story rich" data-emoji="üìñ">üìñ –ì–ª—É–±–æ–∫–∏–π —Å—é–∂–µ—Ç</div>
                </div>
            </div>

            <button onclick="getAI()" class="btn-ai">‚ú® AI –°–æ–≤–µ—Ç</button>
            
            <div style="display: flex;">
                <input type="text" id="friend-id" class="input-friend" placeholder="ID –¥—Ä—É–≥–∞ / –°—Å—ã–ª–∫–∞">
                <button onclick="loadLibrary(true)" class="btn-friend">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="ai-block"></div>
    <div id="status-bar"></div>
    <div class="gallery" id="container"></div>

    <script>
        let loadedGames = [];
        let isProcessing = false;
        let currentMood = "hidden gems";

        /* --- –õ–û–ì–ò–ö–ê –ú–ï–ù–Æ –ù–ê–°–¢–†–û–ï–ù–ò–Ø --- */
        document.getElementById('mood-trigger').addEventListener('click', function(e) {
            const menu = document.getElementById('mood-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            e.stopPropagation();
        });

        document.querySelectorAll('.mood-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.mood-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentMood = this.getAttribute('data-value');
                document.getElementById('current-mood-emoji').innerText = this.getAttribute('data-emoji');
                document.getElementById('mood-menu').style.display = 'none';
            });
        });

        window.addEventListener('click', function() {
            const menu = document.getElementById('mood-menu');
            if (menu) menu.style.display = 'none';
        });

        /* --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò --- */
        function clearList() {
            if(isProcessing) return;
            document.getElementById('container').innerHTML = '';
            loadedGames = [];
            document.getElementById('status-bar').innerText = '';
            document.getElementById('ai-block').style.display = 'none';
        }

        async function getAI() {
            if (loadedGames.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–≥—Ä—ã!"); return; }
            const block = document.getElementById('ai-block');
            block.style.display = 'block';
            block.innerHTML = '<span class="spinner"></span> –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...';
            
            try {
                const resp = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ games: loadedGames, mood: currentMood })
                });
                const data = await resp.json();
                const recs = data.content.recommendations;
                
                if(recs && recs.length > 0) {
                    let html = '<h3 style="color:#fff; margin:0 0 10px 0;">ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3><div class="ai-gallery">';
                    // –ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ getAI() –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –µ–≥–æ:
                recs.forEach(r => {
                    html += `
                    <div class="card" style="animation:none; width: 300px;">
                        <a href="https://store.steampowered.com/app/${r.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                            <img src="${r.image_url}" onerror="this.src='https://via.placeholder.com/280x130/171a21/c7d5e0?text=No+Image'">
                            <div class="info">
                                <h2>${r.name}</h2>
                                <!-- –ù–û–í–û–ï –ü–û–õ–ï: –ù–∞ –æ—Å–Ω–æ–≤–µ —á–µ–≥–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ -->
                                <div style="font-size: 11px; color: #66c0f4; margin-bottom: 8px; font-weight: bold;">
                                    ‚≠ê –ù–∞ –æ—Å–Ω–æ–≤–µ: ${r.based_on}
                                </div>
                                <div class="playtime" style="color: #c7d5e0; margin-top:5px; line-height:1.4; font-size: 12px;">${r.ai_reason}</div>
                            </div>
                        </a>
                        <div class="price-block">
                            <div></div>
                            <div class="price">–û—Ç–∫—Ä—ã—Ç—å –≤ Steam</div>
                        </div>
                    </div>`;
                });
                    html += '</div>';
                    block.innerHTML = html;
                } else {
                    block.innerHTML = '–ò–ò –Ω–µ –¥–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å.';
                }
            } catch(e) {
                block.innerHTML = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI.';
            }
        }

        async function loadLibrary(isFriend = false) {
            if (isProcessing) return;
            isProcessing = true;
            
            if (!isFriend && "{{ user_id }}" === "None") {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Steam!");
                isProcessing = false;
                return;
            }

            const btn = document.getElementById('btn-main');
            if (btn) btn.disabled = true;
            clearList();

            const statusBar = document.getElementById('status-bar');
            
            try {
                let url = '/api/get-games-list';
                if (isFriend) {
                    const inp = document.getElementById('friend-id').value;
                    if(inp) url += `?user_id=${encodeURIComponent(inp)}`;
                }

                statusBar.innerHTML = '<span class="spinner"></span>–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä...';
                
                const listResp = await fetch(url);
                const listData = await listResp.json();

                if (listData.error) {
                    statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞: ${listData.error}</span>`;
                    isProcessing = false; if(btn) btn.disabled = false; return;
                }

                const gamesList = listData.games;
                if (!gamesList || gamesList.length === 0) {
                    statusBar.innerText = "–ò–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
                    isProcessing = false; if(btn) btn.disabled = false; return;
                }

                statusBar.innerText = `–ù–∞–π–¥–µ–Ω–æ ${gamesList.length} –∏–≥—Ä. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏...`;

                const steamIds = gamesList.map(g => g.appid);
                const playtimes = {};
                const gameNames = {};
                gamesList.forEach(g => {
                    playtimes[g.appid] = g.playtime_forever;
                    gameNames[g.appid] = g.name; 
                });

                const batchResp = await fetch('/api/games-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ steam_ids: steamIds, playtimes: playtimes, game_names: gameNames })
                });

                const reader = batchResp.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";
                let count = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split("\n");
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const game = JSON.parse(line);
                                loadedGames.push(game);
                                addCard(game);
                                count++;
                                statusBar.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${count} –∏–∑ ${gamesList.length}`;
                            } catch (e) { console.error(e); }
                        }
                    }
                }
                statusBar.innerHTML = `‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (${count} —à—Ç)`;

            } catch (e) {
                console.error(e);
                statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>`;
            } finally {
                isProcessing = false;
                if(btn) btn.disabled = false;
            }
        }

        function addCard(game) {
            const div = document.createElement('div');
            div.className = 'card';
            
            let displayPrice = game.price_str || "";
            let priceAttr = "";
            let extraClass = "";
            let hideDiscount = false;

            if (displayPrice.startsWith("LOCKED|")) {
                const parts = displayPrice.split("|");
                displayPrice = "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –†–§";
                priceAttr = `data-price="–¶–µ–Ω–∞ –≤ –º–∏—Ä–µ: ${parts[1]}"`;
                extraClass = "region-locked";
                hideDiscount = true;
            } 
            else if (displayPrice.includes("–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ") || displayPrice.includes("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")) {
                div.style.borderColor = "#ff444455";
                extraClass = "blocked";
            }

            let hours = Math.round(game.playtime_forever / 60);
            let timeStr = hours > 0 ? `${hours} —á. –≤ –∏–≥—Ä–µ` : "–ù–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å";
            let discountHtml = (game.discount_percent > 0 && !hideDiscount) 
                ? `<div class="discount-badge">-${game.discount_percent}%</div>` 
                : '<div></div>';
            
            let priceClass = "price " + extraClass;
            if (displayPrice === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") priceClass += " free";

            div.innerHTML = `
                <a href="https://store.steampowered.com/app/${game.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                    <img src="${game.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/280x130/171a21/c7d5e0?text=No+Image'">
                    <div class="info">
                        <h2>${game.name}</h2>
                        <div class="genres">${game.genres || ""}</div>
                        <div class="playtime">${timeStr}</div>
                    </div>
                </a>
                <div class="price-block">
                    ${discountHtml}
                    <div class="${priceClass}" ${priceAttr}>${displayPrice}</div>
                </div>
            `;
            document.getElementById('container').appendChild(div);
        }

        function sortGames(type) {
            const container = document.getElementById('container');
            if (loadedGames.length === 0) return;
            container.innerHTML = '';

            loadedGames.sort((a, b) => {
                if (type === 'playtime') return b.playtime_forever - a.playtime_forever;
                if (type === 'price') {
                    const getPriceValue = (s) => {
                        if (!s || s === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") return 0;
                        let targetString = s.startsWith("LOCKED|") ? s.split("|")[1] : s;
                        if (targetString.includes("–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ") || targetString.includes("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")) return -1;
                        let clean = targetString.replace(/\s/g, '').replace(',', '.').replace(/[^0-9.]/g, '');
                        let num = parseFloat(clean);
                        return isNaN(num) ? -1 : num;
                    };
                    return getPriceValue(b.price_str) - getPriceValue(a.price_str);
                }
            });
            loadedGames.forEach(addCard);
        }
    </script>
</body>
</html>