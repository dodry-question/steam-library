<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Steam Library Viewer</title>
    <link rel="icon" href="https://store.steampowered.com/favicon.ico">
    <style>
        body { background-color: #1b2838; color: #c7d5e0; font-family: sans-serif; margin: 0; padding: 20px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; background: #171a21; padding: 15px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); margin-bottom: 20px; }
        h1 { margin: 0; color: #66c0f4; text-transform: uppercase; font-size: 22px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: #101216; padding: 10px; border-radius: 4px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #3e464e; }
        
        button { cursor: pointer; border: none; padding: 10px 15px; border-radius: 2px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-load { background: linear-gradient(to bottom, #a4d007 5%, #536904 95%); }
        .btn-load:hover { background: #b6e608; }
        .btn-load:disabled { background: #444; cursor: not-allowed; }
        
        .btn-sort { background: #2a475e; color: #66c0f4; }
        .btn-sort:hover { background: #3c5d75; color: white; }
        
        .btn-ai { background: linear-gradient(45deg, #6b2cf5, #b829e3); }

        input { background: #2a3f5a; border: 1px solid #000; color: white; padding: 8px; border-radius: 2px; width: 200px; }

        /* Grid */
        .gallery { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        
        /* Card */
        .card { 
            width: 250px; background: #16202d; border: 1px solid #000; position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: transform 0.2s;
            opacity: 0; animation: fadeIn 0.5s forwards; /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .card:hover { transform: translateY(-5px); border-color: #66c0f4; z-index: 10; }
        .card img { width: 100%; height: 117px; object-fit: cover; display: block; background: #000; }
        .card-body { padding: 8px; font-size: 13px; }
        .game-title { color: #fff; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-bottom: 4px; }
        .game-genres { color: #5c7e10; font-size: 11px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .game-time { color: #8f98a0; font-size: 11px; }
        
        .price-tag { 
            position: absolute; top: 0; right: 0; 
            background: rgba(0,0,0,0.8); color: #fff; 
            padding: 3px 6px; font-size: 12px; font-weight: bold; 
        }
        .discount { color: #beee11; }
        
        /* Status Bar */
        #status-bar { color: #8f98a0; margin-bottom: 10px; font-size: 14px; min-height: 20px; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #66c0f4; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI Section */
        #ai-block { display: none; background: #222; padding: 15px; margin-bottom: 20px; border-left: 4px solid #6b2cf5; }
    </style>
</head>
<body>

<div class="header">
    <h1>Steam Viewer</h1>
    <div>
        {% if user_id %}
            <span style="color: #66c0f4; margin-right: 10px;">ID: {{ user_id }}</span>
            <a href="/logout" style="color: #aaa; text-decoration: none;">–í—ã–π—Ç–∏</a>
        {% else %}
            <a href="/login" style="background: #2a475e; padding: 5px 10px; color: white; text-decoration: none;">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Steam</a>
        {% endif %}
    </div>
</div>

<div class="controls">
    <button onclick="loadLibrary()" class="btn-load" id="btn-main">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
    <button onclick="clearList()" style="background: #333;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <span style="border-left: 1px solid #555; margin: 0 5px;"></span>
    <button onclick="sortGames('playtime')" class="btn-sort">–í—Ä–µ–º—è</button>
    <button onclick="sortGames('price')" class="btn-sort">–¶–µ–Ω–∞</button>
    <span style="border-left: 1px solid #555; margin: 0 5px;"></span>
    <button onclick="getAI()" class="btn-ai">‚ú® AI –°–æ–≤–µ—Ç</button>
    
    <input type="text" id="friend-id" placeholder="ID –¥—Ä—É–≥–∞ / –°—Å—ã–ª–∫–∞">
    <button onclick="loadLibrary(true)" class="btn-sort">–ù–∞–π—Ç–∏</button>
</div>

<div id="status-bar"></div>
<div id="ai-block"></div>
<div class="gallery" id="container"></div>

<script>
    let loadedGames = [];
    let isProcessing = false;

    function clearList() {
        if(isProcessing) return;
        document.getElementById('container').innerHTML = '';
        loadedGames = [];
        document.getElementById('status-bar').innerText = '';
        document.getElementById('ai-block').style.display = 'none';
    }

    async function loadLibrary(isFriend = false) {
        if (isProcessing) return;
        isProcessing = true;
        
        const btn = document.getElementById('btn-main');
        btn.disabled = true;
        clearList();

        const statusBar = document.getElementById('status-bar');
        
        try {
            // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID
            let url = '/api/get-games-list';
            if (isFriend) {
                const inp = document.getElementById('friend-id').value;
                if(inp) url += `?user_id=${encodeURIComponent(inp)}`;
            }

            statusBar.innerHTML = '<span class="spinner"></span>–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä...';
            
            const listResp = await fetch(url);
            const listData = await listResp.json();

            if (listData.error) {
                statusBar.innerText = "–û—à–∏–±–∫–∞: " + listData.error;
                isProcessing = false;
                btn.disabled = false;
                return;
            }

            const gamesList = listData.games;
            if (!gamesList || gamesList.length === 0) {
                statusBar.innerText = "–ò–≥—Ä –Ω–µ—Ç –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç.";
                isProcessing = false;
                btn.disabled = false;
                return;
            }

            statusBar.innerText = `–ù–∞–π–¥–µ–Ω–æ ${gamesList.length} –∏–≥—Ä. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...`;

            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞—Ç—á –∑–∞–ø—Ä–æ—Å
            // –ú—ã –ø–æ—Å—ã–ª–∞–µ–º –í–°–ï ID, –±—ç–∫–µ–Ω–¥ —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è —Å –æ—á–µ—Ä–µ–¥—å—é
            const steamIds = gamesList.map(g => g.appid);
            const playtimes = {};
            gamesList.forEach(g => playtimes[g.appid] = g.playtime);

            const batchResp = await fetch('/api/games-batch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ steam_ids: steamIds, playtimes: playtimes })
            });

            // 3. –ß–∏—Ç–∞–µ–º –ø–æ—Ç–æ–∫ (NDJSON)
            const reader = batchResp.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            let count = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n");
                buffer = lines.pop(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const game = JSON.parse(line);
                        loadedGames.push(game);
                        addCard(game);
                        count++;
                        statusBar.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${count} / ${gamesList.length}`;
                    } catch (e) {
                        console.error("JSON Error", e);
                    }
                }
            }
            statusBar.innerText = `–ì–æ—Ç–æ–≤–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${count} –∏–≥—Ä.`;

        } catch (e) {
            console.error(e);
            statusBar.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.";
        } finally {
            isProcessing = false;
            btn.disabled = false;
        }
    }

    function addCard(game) {
        const div = document.createElement('div');
        div.className = 'card';
        
        let hours = Math.round(game.playtime_forever / 60);
        let timeStr = hours > 0 ? `${hours} —á.` : "";
        let price = game.price_str || "";
        let discountClass = game.discount_percent > 0 ? "discount" : "";

        div.innerHTML = `
            <a href="https://store.steampowered.com/app/${game.steam_id}" target="_blank" style="text-decoration:none;">
                <img src="${game.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/250x117?text=No+Image'">
                <div class="price-tag ${discountClass}">
                    ${game.discount_percent > 0 ? `-${game.discount_percent}% ` : ''} ${price}
                </div>
                <div class="card-body">
                    <span class="game-title" title="${game.name}">${game.name}</span>
                    <div class="game-genres">${game.genres || ""}</div>
                    <div class="game-time">${timeStr}</div>
                </div>
            </a>
        `;
        document.getElementById('container').appendChild(div);
    }

    function sortGames(type) {
        const container = document.getElementById('container');
        container.innerHTML = '';
        
        loadedGames.sort((a, b) => {
            if (type === 'playtime') return b.playtime_forever - a.playtime_forever;
            if (type === 'price') {
                const getP = (s) => s && s.includes('‚ÇΩ') ? parseInt(s.replace(/\D/g,'')) : 0;
                return getP(b.price_str) - getP(a.price_str);
            }
        });
        
        loadedGames.forEach(addCard);
    }

    async function getAI() {
        const block = document.getElementById('ai-block');
        block.style.display = 'block';
        block.innerHTML = 'ü§ñ –î—É–º–∞—é...';
        
        try {
            const resp = await fetch('/api/recommend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ games: loadedGames })
            });
            const data = await resp.json();
            const recs = data.content.recommendations;
            if(recs && recs.length > 0) {
                let html = '<h3>‚ú® AI –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç:</h3><div style="display:flex; gap:10px; flex-wrap:wrap;">';
                recs.forEach(r => {
                    html += `
                    <div style="background:#333; padding:10px; width:200px; border-radius:4px;">
                        <img src="${r.image_url}" style="width:100%">
                        <b>${r.name}</b>
                        <p style="font-size:12px; color:#aaa;">${r.ai_reason}</p>
                    </div>`;
                });
                html += '</div>';
                block.innerHTML = html;
            } else {
                block.innerHTML = 'AI –Ω–µ —Å–º–æ–≥ –Ω–∏—á–µ–≥–æ –ø—Ä–∏–¥—É–º–∞—Ç—å :(';
            }
        } catch(e) {
            block.innerHTML = '–û—à–∏–±–∫–∞ AI';
        }
    }
</script>

</body>
</html>