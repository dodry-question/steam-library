<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?v=7">
    <style>

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è –¥–ª—è –ò–ò —Å —Ü–µ–Ω—Ç—Ä–æ–≤–∫–æ–π */
#ai-block .ai-gallery {
    display: flex;
    justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ */
    flex-wrap: wrap;
    gap: 16px;
    margin-top: 15px;
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ */
.mood-container {
    position: relative;
    display: inline-block;
    vertical-align: middle;
}

.mood-trigger {
    background: #2a2d33;
    border: 1px solid #3e464e;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: 0.2s;
    font-size: 18px; /* –ß—Ç–æ–±—ã —Å–º–∞–π–ª–∏–∫ –±—ã–ª –∫—Ä—É–ø–Ω–µ–µ */
}

.mood-trigger:hover {
    border-color: #6b2cf5;
    background: #353941;
}

.mood-trigger .arrow {
    font-size: 10px;
    color: #697885;
}

.mood-menu {
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    position: absolute;
    top: 110%;
    right: 0;
    background: #171a21;
    border: 1px solid #6b2cf5;
    border-radius: 4px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.8);
    z-index: 2000;
    min-width: 220px;
    overflow: hidden;
}

.mood-item {
    padding: 10px 15px;
    color: #c7d5e0;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.mood-item:hover {
    background: #6b2cf5;
    color: white;
}

.mood-item.active {
    background: #2a3f5a;
    color: #66c0f4;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –†–§" */
.price.region-locked {
    color: #ff4444; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç */
    cursor: default;
    text-decoration: none; /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
    position: relative;
    font-weight: bold;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã —Ü–µ–Ω–∞ –≤ $ –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) */
.price.region-locked::after {
    content: attr(data-price);
    position: absolute;
    bottom: 125%;
    right: 0;
    background: #171a21;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #ff4444;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: 0.2s;
    z-index: 100;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    font-weight: normal;
}

.price.region-locked:hover::after {
    opacity: 1;
    visibility: visible;
}

        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; padding: 40px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background-color: #171a21; padding: 15px 20px; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1 { color: #ffffff; text-shadow: 0 0 5px #66c0f4; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-profile { display: flex; align-items: center; justify-content: flex-end; }
        .price.blocked { color: #ff6c6c; font-size: 12px; }
        .user-info-col { display: flex; flex-direction: column; justify-content: center; line-height: 1.2; text-align: right; margin-right: 12px; }
        .user-name { font-weight: bold; color: #66c0f4; font-size: 14px; white-space: nowrap; }
        .btn-logout { color: #8f98a0; text-decoration: none; font-size: 11px; text-transform: uppercase; }
        .btn-logout:hover { color: #ffffff; text-decoration: underline; }
        
        .btn-steam { background-color: #2f363d; color: #e5e5e5; text-decoration: none; padding: 8px 16px; font-weight: bold; display: inline-flex; align-items: center; gap: 10px; border-radius: 2px; border: 1px solid #3e464e; transition: 0.2s; font-size: 14px; }
        .btn-steam:hover { background-color: #434953; color: white; border-color: #66c0f4; }
        .steam-icon { width: 18px; height: 18px; background: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Steam_icon_logo.svg') no-repeat center/contain; }

        .controls { background: #101216; padding: 15px; border-radius: 4px; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 20px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.8); border: 1px solid #3e464e; }
        .controls-right { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        button { padding: 8px 16px; border-radius: 2px; border: none; font-weight: normal; cursor: pointer; transition: 0.2s; color: white; font-size: 13px; font-family: 'Segoe UI', sans-serif; }
        .btn-load { background: linear-gradient( to bottom, #a4d007 5%, #536904 95%); color: #fff; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); font-weight: bold; }
        .btn-load:hover { background: linear-gradient( to bottom, #b6e608 5%, #536904 95%); }
        .btn-clear { background-color: #2a2d33; color: #aaa; }
        .btn-sort { background-color: #2a3f5a; color: #66c0f4; }
        .btn-ai { background: linear-gradient(45deg, #6b2cf5, #b829e3); font-weight: bold; }

        .input-friend { padding: 8px; border-radius: 2px 0 0 2px; border: 1px solid #3e464e; background: #222b35; color: white; width: 180px; }
        .btn-friend { border-radius: 0 2px 2px 0; background-color: #67c1f5; color: #1b2838; font-weight: bold; }

        .gallery { display: flex; flex-wrap: wrap; gap: 16px; }
        
        .card { 
            background-color: #16202d; width: 280px; position: relative; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.2); 
            animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column; 
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.5); border-color: #66c0f4; z-index: 10; }
        
        img { width: 100%; min-height: 130px; object-fit: cover; background: #0c0f12; }
        .info { padding: 10px; flex-grow: 1; }
        h2 { font-size: 15px; margin: 0 0 5px 0; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .genres { font-size: 11px; color: #5c7e10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playtime { font-size: 11px; color: #697885; margin-top: 2px; }
        
        .price-block { display: flex; justify-content: space-between; align-items: center; background-color: #00000033; padding: 6px 10px; margin-top: auto; }
        .price { font-size: 13px; color: #acb2b8; }
        .price.free { color: #a4d007; font-weight: bold; } 
        .discount-badge { background-color: #4c6b22; color: #beee11; padding: 1px 4px; border-radius: 1px; font-size: 13px; font-weight: bold; }

        #ai-block { display: none; background: #121418; border: 1px solid #6b2cf5; padding: 20px; margin-bottom: 30px; }
        #status-bar { margin-bottom: 20px; color: #66c0f4; font-size: 14px; font-weight: bold; min-height: 20px; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #66c0f4; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite; margin-right: 8px; vertical-align: text-bottom; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
    
    {% if user_id %}
        <!-- –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è, –∫–æ–≥–¥–∞ –≤–æ—à–ª–∏ -->
        <div class="user-profile" style="display: flex; align-items: center;">
            <div class="user-info-col" style="margin-right: 12px; text-align: right; display: flex; flex-direction: column; justify-content: center;">
                <span class="user-name" style="display: block; line-height: 1.2;">{{ user_name }}</span>
                <a href="/logout" class="btn-logout" style="display: block; line-height: 1.2;">–í—ã–π—Ç–∏</a>
            </div>
            <div style="width: 40px; height: 40px; border: 1px solid #66c0f4; border-radius: 4px; overflow: hidden; background: #171a21; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <img src="{{ user_avatar }}" 
                     style="width: 100%; height: 100%; object-fit: contain;" 
                     onerror="this.src='https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg'">
            </div>
        </div>
    {% else %}
        <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞, –∫–æ–≥–¥–∞ –Ω–µ –≤–æ—à–ª–∏ -->
        <div style="margin-left: auto;">
            <a href="/login" class="btn-steam">
                <div class="steam-icon"></div>
                Sign in through Steam
            </a>
        </div>
    {% endif %}
</div>

    <div class="controls">
    {% if user_id %}
        <button onclick="loadLibrary()" class="btn-load" id="btn-main">–ú–æ–∏ –∏–≥—Ä—ã</button>
    {% endif %}
    <button onclick="clearList()" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <span style="color: #454d58;">|</span>
    <button onclick="sortGames('playtime')" class="btn-sort">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</button>
    <button onclick="sortGames('price')" class="btn-sort">–ü–æ —Ü–µ–Ω–µ</button>

    <div class="controls-right">
        <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (–°–º–∞–π–ª–∏–∫ + —Å—Ç—Ä–µ–ª–æ—á–∫–∞) -->
        <div class="mood-container">
            <div class="mood-trigger" id="mood-trigger" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏">
                <span id="current-mood-emoji">üíé</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="mood-menu" id="mood-menu">
                <div class="mood-item active" data-value="hidden gems" data-emoji="üíé">üíé –°–∫—Ä—ã—Ç—ã–µ –∂–µ–º—á—É–∂–∏–Ω—ã</div>
                <div class="mood-item" data-value="experimental indie" data-emoji="üß™">üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –∏–Ω–¥–∏</div>
                <div class="mood-item" data-value="hardcore challenge" data-emoji="üíÄ">üíÄ –•–∞—Ä–¥–∫–æ—Ä –∏ –≤—ã–∑–æ–≤</div>
                <div class="mood-item" data-value="relaxing atmosphere" data-emoji="‚òï">‚òï –ú–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–æ–µ / –û—Ç–¥—ã—Ö</div>
                <div class="mood-item" data-value="story rich" data-emoji="üìñ">üìñ –ì–ª—É–±–æ–∫–∏–π —Å—é–∂–µ—Ç</div>
            </div>
        </div>

        <button onclick="getAI()" class="btn-ai">‚ú® AI –°–æ–≤–µ—Ç</button>
        
        <div style="display: flex;">
            <input type="text" id="friend-id" class="input-friend" placeholder="ID –¥—Ä—É–≥–∞ / –°—Å—ã–ª–∫–∞">
            <button onclick="loadLibrary(true)" class="btn-friend">–ù–∞–π—Ç–∏</button>
        </div>
    </div>
</div>
</div>
            <button onclick="getAI()" class="btn-ai">‚ú® AI –°–æ–≤–µ—Ç</button>
            <div style="display: flex;">
                <input type="text" id="friend-id" class="input-friend" placeholder="ID –¥—Ä—É–≥–∞ / –°—Å—ã–ª–∫–∞">
                <button onclick="loadLibrary(true)" class="btn-friend">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="ai-block"></div>
    <div id="status-bar"></div>
    <div class="gallery" id="container"></div>

    <script>
        let loadedGames = [];
        let isProcessing = false;

        function clearList() {
            if(isProcessing) return;
            document.getElementById('container').innerHTML = '';
            loadedGames = [];
            document.getElementById('status-bar').innerText = '';
            document.getElementById('ai-block').style.display = 'none';
        }

        // –õ–æ–≥–∏–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
let currentMood = "hidden gems";

document.getElementById('mood-trigger').addEventListener('click', function(e) {
    const menu = document.getElementById('mood-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    e.stopPropagation();
});

// –í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é
document.querySelectorAll('.mood-item').forEach(item => {
    item.addEventListener('click', function() {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∏ —Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–µ–º—É
        document.querySelectorAll('.mood-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–º–∞–π–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        currentMood = this.getAttribute('data-value');
        document.getElementById('current-mood-emoji').innerText = this.getAttribute('data-emoji');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        document.getElementById('mood-menu').style.display = 'none';
    });
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞
window.addEventListener('click', function() {
    document.getElementById('mood-menu').style.display = 'none';
});

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è getAI
async function getAI() {
    if (loadedGames.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–≥—Ä—ã!"); return; }
    
    const block = document.getElementById('ai-block');
    block.style.display = 'block';
    block.innerHTML = '<span class="spinner"></span> –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...';
    
    try {
        const resp = await fetch('/api/recommend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                games: loadedGames,
                mood: currentMood // –ü–µ—Ä–µ–¥–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ –º–µ–Ω—é
            })
        });
        const data = await resp.json();
        const recs = data.content.recommendations;
        
        if(recs && recs.length > 0) {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú ai-gallery –î–õ–Ø –¶–ï–ù–¢–†–û–í–ö–ò
            let html = '<h3 style="color:#fff; margin-top:0;">ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3><div class="ai-gallery">';
            
            recs.forEach(r => {
                html += `
                <div class="card" style="animation:none; width: 300px;">
                     <a href="https://store.steampowered.com/app/${r.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                        <img src="${r.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/280x130/171a21/c7d5e0?text=No+Image'">
                        <div class="info">
                            <h2>${r.name}</h2>
                            <div class="playtime" style="color: #beee11; margin-top:5px; line-height:1.4; font-size: 12px;">${r.ai_reason}</div>
                        </div>
                    </a>
                    <div class="price-block">
                        <div></div>
                        <div class="price">–û—Ç–∫—Ä—ã—Ç—å –≤ Steam</div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            block.innerHTML = html;
        } else {
            block.innerHTML = '–ò–ò –Ω–µ –¥–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É.';
        }
    } catch(e) {
        block.innerHTML = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI.';
    }
}

        async function loadLibrary(isFriend = false) {
            if (isProcessing) return;
            isProcessing = true;
            
            if (!isFriend && "{{ user_id }}" === "None") {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Steam!");
                isProcessing = false;
                return;
            }

            const btn = document.getElementById('btn-main');
            if (btn) btn.disabled = true;
            clearList();

            const statusBar = document.getElementById('status-bar');
            
            try {
                let url = '/api/get-games-list';
                if (isFriend) {
                    const inp = document.getElementById('friend-id').value;
                    if(inp) url += `?user_id=${encodeURIComponent(inp)}`;
                }

                statusBar.innerHTML = '<span class="spinner"></span>–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä...';
                
                const listResp = await fetch(url);
                if (!listResp.ok) throw new Error(`HTTP ${listResp.status}`);
                const listData = await listResp.json();

                if (listData.error) {
                    statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞: ${listData.error}</span>`;
                    isProcessing = false;
                    if(btn) btn.disabled = false;
                    return;
                }

                const gamesList = listData.games;
                if (!gamesList || gamesList.length === 0) {
                    statusBar.innerText = "–ò–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
                    isProcessing = false;
                    if(btn) btn.disabled = false;
                    return;
                }

                statusBar.innerText = `–ù–∞–π–¥–µ–Ω–æ ${gamesList.length} –∏–≥—Ä. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏...`;

                const steamIds = gamesList.map(g => g.appid);
                const playtimes = {};
                const gameNames = {};
                gamesList.forEach(g => {
                    playtimes[g.appid] = g.playtime_forever;
                    gameNames[g.appid] = g.name; 
                });

                const batchResp = await fetch('/api/games-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        steam_ids: steamIds, 
                        playtimes: playtimes,
                        game_names: gameNames 
                    })
                });

                const reader = batchResp.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";
                let count = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split("\n");
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const game = JSON.parse(line);
                                loadedGames.push(game);
                                addCard(game);
                                count++;
                                statusBar.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${count} –∏–∑ ${gamesList.length}`;
                            } catch (e) { console.error(e); }
                        }
                    }
                }
                statusBar.innerHTML = `‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (${count} —à—Ç)`;

            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞: " + e.message);
                statusBar.innerHTML = `<span style="color: #ff6c6c;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>`;
            } finally {
                isProcessing = false;
                if(btn) btn.disabled = false;
            }
        }

        function addCard(game) {
    const div = document.createElement('div');
    div.className = 'card';
    
    let displayPrice = game.price_str || "";
    let priceAttr = "";
    let extraClass = "";
    let hideDiscount = false; // –§–ª–∞–≥ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–∫–∏–¥–∫–∏

    // 1. –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–≥—Ä, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ –†–§
    if (displayPrice.startsWith("LOCKED|")) {
        const parts = displayPrice.split("|");
        displayPrice = "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –†–§";
        priceAttr = `data-price="–¶–µ–Ω–∞ –≤ –º–∏—Ä–µ: ${parts[1]}"`;
        extraClass = "region-locked";
        hideDiscount = true; // –°–∫—Ä—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä
    } 
    else if (displayPrice.includes("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")) {
        div.style.borderColor = "#ff444455";
        extraClass = "blocked";
    }

    let hours = Math.round(game.playtime_forever / 60);
    let timeStr = hours > 0 ? `${hours} —á. –≤ –∏–≥—Ä–µ` : "–ù–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
    let discountHtml = (game.discount_percent > 0 && !hideDiscount) 
        ? `<div class="discount-badge">-${game.discount_percent}%</div>` 
        : '<div></div>';
    
    let priceClass = "price " + extraClass;
    if (displayPrice === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") priceClass += " free";

    div.innerHTML = `
        <a href="https://store.steampowered.com/app/${game.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
            <img src="${game.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/280x130/171a21/c7d5e0?text=No+Image'">
            <div class="info">
                <h2>${game.name}</h2>
                <div class="genres">${game.genres || ""}</div>
                <div class="playtime">${timeStr}</div>
            </div>
        </a>
        <div class="price-block">
            ${discountHtml}
            <div class="${priceClass}" ${priceAttr}>${displayPrice}</div>
        </div>
    `;
    document.getElementById('container').appendChild(div);
}

        function sortGames(type) {
    const container = document.getElementById('container');
    if (loadedGames.length === 0) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∏–¥–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    container.innerHTML = '';

    loadedGames.sort((a, b) => {
        if (type === 'playtime') {
            return b.playtime_forever - a.playtime_forever;
        }

        if (type === 'price') {
            const getPriceValue = (s) => {
                if (!s || s === "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ") return 0;
                
                let targetString = s;
                // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –±–µ—Ä–µ–º —Ü–µ–Ω—É –∏–∑ –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏ (–ø–æ—Å–ª–µ |)
                if (s.startsWith("LOCKED|")) {
                    targetString = s.split("|")[1];
                }

                if (targetString.includes("–ù–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ") || targetString.includes("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ")) {
                    return -1; // –£–≤–æ–¥–∏–º –∏–≥—Ä—ã –±–µ–∑ —Ü–µ–Ω—ã –≤ —Å–∞–º—ã–π –Ω–∏–∑
                }

                // –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É: —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É
                let clean = targetString.replace(/\s/g, '').replace(',', '.').replace(/[^0-9.]/g, '');
                let num = parseFloat(clean);
                
                return isNaN(num) ? -1 : num;
            };

            let valA = getPriceValue(a.price_str);
            let valB = getPriceValue(b.price_str);

            return valB - valA; // –û—Ç –¥–æ—Ä–æ–≥–∏—Ö –∫ –¥–µ—à–µ–≤—ã–º
        }
    });

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    loadedGames.forEach(addCard);
}

        async function getAI() {
    if (loadedGames.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–≥—Ä—ã!"); return; }
    const mood = document.getElementById('ai-mood').value; // –ë–µ—Ä–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    const block = document.getElementById('ai-block');
    block.style.display = 'block';
    block.innerHTML = '<span class="spinner"></span> –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...';
    
    try {
        const resp = await fetch('/api/recommend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                games: loadedGames,
                mood: mood // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ –±—ç–∫–µ–Ω–¥
            })
        });
                const data = await resp.json();
                const recs = data.content.recommendations;
                
                if(recs && recs.length > 0) {
                    let html = '<h3 style="color:#fff; margin-top:0;">ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3><div class="gallery" style="margin-top:10px;">';
                    
                    recs.forEach(r => {
                        html += `
                        <div class="card" style="animation:none;">
                             <a href="https://store.steampowered.com/app/${r.steam_id}" target="_blank" style="text-decoration:none; color:inherit; flex-grow:1;">
                                <img src="${r.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/280x130/171a21/c7d5e0?text=No+Image'">
                                <div class="info">
                                    <h2>${r.name}</h2>
                                    <div class="playtime" style="color: #beee11; margin-top:5px; line-height:1.2;">${r.ai_reason}</div>
                                </div>
                            </a>
                            <div class="price-block">
                                <div></div>
                                <div class="price">–û—Ç–∫—Ä—ã—Ç—å –≤ Steam</div>
                            </div>
                        </div>`;
                    });
                    
                    html += '</div>';
                    block.innerHTML = html;
                } else {
                    block.innerHTML = '–ò–ò –Ω–µ –¥–∞–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞.';
                }
            } catch(e) {
                block.innerHTML = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI.';
            }
        }
    </script>
</body>
</html>